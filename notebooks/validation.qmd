---
title: "Manuscript Validation"
format: pdf
execute-dir: file
fig-width: 8
fig-height: 5
execute: 
  echo: false
  warning: false
---

```{r setup}
#| include: false
#| 
library(sf)
library(arrow)
library(tidyverse)
library(patchwork)
library(gguw)
library(showtext)
showtext_auto()
font_add("Arial", regular = "LiberationSans-Regular.ttf") 
scipen = 999

theme_set(
  theme_uw() +
  theme(
    plot.title = element_blank(),#element_text(size = 18, hjust = 0.5),
    axis.line = element_line(linewidth = .1),
    axis.ticks = element_line(), 
    text = element_text(family = 'Arial'), 
    axis.title.x = element_blank(),
  )
)
pal <- c('WFBZ Disaster' = '#AB3329', 'ICS-209-PLUS' = '#EBAA6C')
```

## Comparison Data Sets

ICS-209-PLUS https://github.com/katiemcconnell/ICS-209-PLUS_spatiotemporal_linkage
<!--
FRESC https://www.sciencebase.gov/catalog/item/61707c2ad34ea36449a6b066 (metadata: https://www.sciencebase.gov/catalog/file/get/61aa537dd34eb622f699df81?f=__disk__d0%2F63%2F53%2Fd063532049be8e1bc83d1d3047b4df1a5cb56f15&transform=1&allowOpen=true)
--> 

```{r data}
ours <- read_sf('../wfbz.geojson') %>% 
	filter(year(wildfire_ignition_date) <= 2020)
ics209plus <- read_csv('../data/reference/ics209-plus-wf_incidents_1999to2020.csv')
#fresc <- st_read(dsn = '../data/reference/Fire_Feature_Data_Pro2_8_Geodatabase/Fire_Feature_Data.gdb/', query = 'select * from USGS_Wildland_Fire_Combined_dataset where Fire_Year >= 1999 and Assigned_Fire_Type not like \'%Prescribed%\'')
compare <- bind_rows(
    ours %>% 
        st_drop_geometry() %>% 
        group_by(Year = wildfire_year) %>% 
        summarize(
            `Wildfire burn zone disasters, N` = n(),
            `Civilian fatalities, N` = sum(wildfire_max_civil_fatalities, na.rm = TRUE),
            `Structures destroyed, N` = sum(wildfire_struct_destroyed, na.rm = TRUE),
            `Total fatalities, N` = sum(wildfire_total_fatalities, na.rm = TRUE)
        ) %>% 
        mutate(dataset = 'WFBZ Disaster'),
    ics209plus %>%
        group_by(INCIDENT_ID) %>%
        slice_head(n = 1) %>% # just take one of the counties
        mutate(
          disaster = (STR_DESTROYED_TOTAL > 0) | ((START_YEAR > 2013) & FATALITIES_PUBLIC > 0) |  ((START_YEAR <= 2013) & FATALITIES > 0)
        ) %>%
        group_by(Year = START_YEAR) %>% 
        summarize(
            `Wildfire burn zone disasters, N` = sum(disaster, na.rm = TRUE),
            `Civilian fatalities, N` = sum(FATALITIES_PUBLIC, na.rm = TRUE),
            `Total fatalities, N` = sum(FATALITIES, na.rm = TRUE),
            `Structures destroyed, N` = sum(STR_DESTROYED_TOTAL, na.rm = TRUE)
        ) %>%
        mutate(dataset = 'ICS-209-PLUS') 
)

```

## Comparison Figures

### Number of Disaster Fires

For ICS209-PLUS, we defined a disaster fire as a fire that destroyed a building, had any fatality in or before 2013, or had a civilian fatality after 2013. 

```{r}
ggplot(compare) + 
  geom_line(aes(x = Year, y = `Wildfire burn zone disasters, N`, color = dataset)) +
	scale_color_manual(values = pal)
```

### Fatalities

```{r}
#| fig-height: 8
p1 <- ggplot() + 
  geom_line(data = compare, aes(x = Year, y = `Civilian fatalities, N`, color = dataset)) +
  annotate('segment', x = 2013.5, xend = 2013.5, y = 0, yend = 50, linetype = 'dashed') +
  annotate('text', x = 2013.5, y = 55, label = 'ICS-209 begins reporting\ncivilian fatalities separately.', size = 3, angle = -55, hjust = 1) + 
	scale_color_manual(values = pal)

p2 <- ggplot() + 
  geom_line(data = compare, aes(x = Year, y = `Total fatalities, N`, color = dataset)) +
	scale_color_manual(values = pal)

p1 + p2 + plot_layout(ncol = 1)
```

### Structures

```{r}
ggplot(compare) + 
  geom_line(aes(x = Year, y = `Structures destroyed, N`, color = dataset)) +	
	scale_color_manual(values = pal) + 
	scale_y_continuous(labels = scales::comma)

```

## Direct Comparisons

### Comparison of sizes of fires

```{r}
ics209plus_dedup <- ics209plus %>%
        group_by(INCIDENT_ID) %>%
        slice_head(n = 1) %>%
				ungroup() %>%
				mutate(
					INCIDENT_ID = if_else(is.na(INCIDENT_ID_OLD), INCIDENT_ID, INCIDENT_ID_OLD)
				)

ours_unnest <- ours %>%
	st_drop_geometry() %>% 
	mutate(ics_id = str_split(ics_id, '\\|')) %>%
	unnest(ics_id)

matches <- inner_join(ics209plus_dedup, ours_unnest, by = c('INCIDENT_ID' = 'ics_id'), na_matches = 'never')

ggplot(matches) + 
	geom_point(aes(x = FINAL_ACRES*0.00404686, y = wildfire_area), alpha = .25) + 
	geom_abline(slope = 1, linetype = 'dashed', color = '#88A0DC') + 
	scale_x_log10(labels = ~ format(.x, nsmall = 1, big.mark = ','), name = "ICS-209-PLUS area (sq. km)", limits = c(1e-4, 10000)) + 
	scale_y_log10(labels = ~ format(.x, nsmall = 1, big.mark = ','), name = "WFBZ Disaster area (sq.km)", limits = c(1e-4, 10000)) + 
	coord_equal() +
	theme(axis.title.x = element_text())
```

We were able to match `r length(unique(matches$INCIDENT_ID))` ICS-209-PLUS records to `r length(unique(matches$wildfire_id))` WFBZ Disaster records (some WFBZ Disasters included multiple records from ICS-209 and therefore corresponded to multiple ICS-209-PLUS records). 

Median Difference (WFBZ Disaster - ICS-209-PLUS): `r median(matches$wildfire_area - (matches$FINAL_ACRES*0.00404686), na.rm = TRUE)`

Median Abs. Difference: `r median(abs(matches$wildfire_area - (matches$FINAL_ACRES*0.00404686)), na.rm = TRUE)`

IQR Difference: `r median((matches$wildfire_area - (matches$FINAL_ACRES*0.00404686)), na.rm = TRUE) - IQR(abs(matches$wildfire_area - (matches$FINAL_ACRES*0.00404686)), na.rm = TRUE)` to `r median((matches$wildfire_area - (matches$FINAL_ACRES*0.00404686)), na.rm = TRUE) + IQR(abs(matches$wildfire_area - (matches$FINAL_ACRES*0.00404686)), na.rm = TRUE)`

IQR Abs. Difference: `r median(abs(matches$wildfire_area - (matches$FINAL_ACRES*0.00404686)), na.rm = TRUE) - IQR(abs(matches$wildfire_area - (matches$FINAL_ACRES*0.00404686)), na.rm = TRUE)` to `r median(abs(matches$wildfire_area - (matches$FINAL_ACRES*0.00404686)), na.rm = TRUE) + IQR(abs(matches$wildfire_area - (matches$FINAL_ACRES*0.00404686)), na.rm = TRUE)`

Spearman Correlation: `r cor(matches$wildfire_area, matches$FINAL_ACRES*0.00404686, method = "spearman",  use = 'pairwise')`

Pearson Correlation: `r cor(matches$wildfire_area, matches$FINAL_ACRES*0.00404686, method = "pearson",  use = 'pairwise')`
