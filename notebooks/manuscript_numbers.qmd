---
title: "Manuscript Numbers"
format: html
editor: visual
execute:
  echo: false
---

Numbers included in text of manuscript.

```{r setup}
#| include: false
library(sf)
library(tidyverse)
library(gt)
library(glue)
library(khroma)
library(tigris)
library(patchwork)
library(targets)
library(arrow)
source("../code/helpers.R")
options(scipen = 999)
tar_load_everything(store = '../_targets') 
final <- read_sf('../wfbz.geojson')
```

## Rows in src data

### ICS209

Rows in ics-minimal data set post 2000.

```{r}
nrow(event_ics209)
```

Non-Missing POO Lat/long

```{r}
sum(!is.na(event_ics209$wildfire_poo_lat))
sum(!is.na(event_ics209$wildfire_poo_lat)) / nrow(event_ics209)
```

Non-Missing County Name (N, pct):

```{r}
sum(!is.na(event_ics209$wildfire_counties))
sum(!is.na(event_ics209$wildfire_counties)) / nrow(event_ics209)
```

### Red Books

```{r}
sum(!is.na(event_redbook$wildfire_counties))
sum(!is.na(event_redbook$wildfire_counties)) / nrow(event_redbook)
```

### FEMA

```{r}
nrow(event_fema)
```

```{r}
sum(!is.na(event_fema$wildfire_counties))
sum(!is.na(event_fema$wildfire_counties)) / nrow(event_fema)
```

## Count in Final Data

total count

```{r}
nrow(final) 
```

met criteria

```{r}
sum(final$wildfire_community_intersect) 
```

met criteria pct

```{r}
sum(final$wildfire_community_intersect) / nrow(final)
```

## BZ types

```{r}
final %>% st_drop_geometry() %>% group_by(geometry_method) %>% summarize(n())
```

with burn zones from spatial files

```{r}
sum(str_detect(final$geometry_src, '(FIRED|MTBS|NIFC)')) 
```

## Time trend

fluctuated from

```{r}
final %>% st_drop_geometry() %>% group_by(wildfire_year) %>% summarize(n=n()) %>%
	filter(n %in% range(n))
```

Compared to 2000-2009, the years between 2010 and 2019 had more wildfire burn disasters

```{r}
final %>% st_drop_geometry() %>% filter(between(wildfire_year, 2000, 2019)) %>% 
	group_by(wildfire_year < 2010) %>% 
	summarize(n=n())
```

more fires that met FMAG

```{r}
final %>% st_drop_geometry() %>% filter(between(wildfire_year, 2000, 2019)) %>% 
	group_by(wildfire_year < 2010) %>% 
	summarize(n=sum(wildfire_fema_dec, na.rm=TRUE))
```

More fires that met structure criterion

```{r}
final %>% st_drop_geometry() %>% filter(between(wildfire_year, 2000, 2019)) %>% 
	group_by(wildfire_year < 2010) %>% 
	summarize(n=sum(str_detect(wildfire_disaster_criteria_met, 'struct'), na.rm=TRUE))
```

```{r}
final %>% st_drop_geometry() %>% filter(between(wildfire_year, 2000, 2019)) %>% 
	group_by(wildfire_year < 2010) %>% 
	summarize(n=sum(str_detect(wildfire_disaster_criteria_met, 'death'), na.rm=TRUE))
```

## States

States with greated number of fires each by year were...

```{r}
final %>% st_drop_geometry() %>% unnest(wildfire_states) %>% group_by(wildfire_states, wildfire_year) %>% summarize(n = n()) %>%
	group_by(wildfire_year) %>%
	filter(n == max(n)) %>%
	arrange(wildfire_year)

```

## Criteria

structure

```{r}
paste(
	sum(str_detect(final$wildfire_disaster_criteria_met, 'struct')),
	100*round(sum(str_detect(final$wildfire_disaster_criteria_met, 'struct')) / nrow(final), digits = 3), '%'
)
```

fema

```{r}
paste(
	sum(str_detect(final$wildfire_disaster_criteria_met, 'dec')),
	100*round(sum(str_detect(final$wildfire_disaster_criteria_met, 'dec')) / nrow(final), digits = 3), '%'
)
```

fatal

```{r}
paste(
	sum(str_detect(final$wildfire_disaster_criteria_met, 'death')),
	100*round(sum(str_detect(final$wildfire_disaster_criteria_met, 'death')) / nrow(final), digits = 3), '%'
)
```

total struct

```{r}
sum(final$wildfire_struct_destroyed,na.rm=T)
```

total death

```{r}
sum(final$wildfire_max_civil_fatalities,na.rm=T)
```

## California only

cali had the most disasters...

```{r}
paste(
	nrow(final %>% filter(str_detect(wildfire_states, 'CA'))),
	format(100*nrow(final %>% filter(str_detect(wildfire_states, 'CA'))) / nrow(final), digits = 3), '%'
)
```

fatalities

```{r}
paste(
	final %>% 
		filter(str_detect(wildfire_states, 'CA')) %>% 
		pull(wildfire_max_civil_fatalities) %>% 
		sum(na.rm=T),
	format(
		100* 	final %>% 
		filter(str_detect(wildfire_states, 'CA')) %>% 
		pull(wildfire_max_civil_fatalities) %>% 
		sum(na.rm=T) %>%
		`/`(sum(final$wildfire_max_civil_fatalities,na.rm=T))
	, digits = 3), '%'
)
```

and structures

```{r}
paste(
	final %>% 
		filter(str_detect(wildfire_states, 'CA')) %>% 
		pull(wildfire_struct_destroyed) %>% 
		sum(na.rm=T),
	format(
		100* 	final %>% 
		filter(str_detect(wildfire_states, 'CA')) %>% 
		pull(wildfire_struct_destroyed) %>% 
		sum(na.rm=T) %>%
		`/`(sum(final$wildfire_struct_destroyed,na.rm=T))
	, digits = 3), '%'
)
```

... and fmags

```{r}
paste(
	final %>% 
		filter(str_detect(wildfire_states, 'CA')) %>% 
		pull(wildfire_fema_dec) %>% 
		sum(na.rm=T),
	format(
		100* 	final %>% 
		filter(str_detect(wildfire_states, 'CA')) %>% 
		pull(wildfire_fema_dec) %>% 
		sum(na.rm=T) %>%
		`/`(sum(final$wildfire_fema_dec,na.rm=T))
	, digits = 3), '%'
)
```

## Among structure destroying fires

this many destroyed fewer than 5

```{r}
	final %>% 
		filter(str_detect(wildfire_disaster_criteria_met, 'struct')) %>%
		st_drop_geometry() %>%
		summarize(
		 gt4 = sum(coalesce(wildfire_struct_destroyed, 0)<= 4, na.rm = T),
		 gt4 / n()
		)
```

## Of fatal fires

only this many resulted in 10 fatalities or 10 structures destroeyd

```{r}
	final %>% 
		st_drop_geometry() %>%
		summarize(
			gt10 = sum((coalesce(wildfire_struct_destroyed, 0) > 10) | (coalesce(wildfire_max_civil_fatalities,0) > 10), na.rm = T),
			gt10 / n()
		)
```

however these fires accounted for...

```{r}
final %>% 
	filter((coalesce(wildfire_struct_destroyed, 0) > 10) | (coalesce(wildfire_max_civil_fatalities,0) > 10)) %>%
	nrow()
```

```{r}
final %>% 
	st_drop_geometry() %>% 
	filter((coalesce(wildfire_struct_destroyed, 0) > 10) | (coalesce(wildfire_max_civil_fatalities,0) > 10)) %>%
	summarize(
		n = paste(n(), '(',  100* n() / nrow(final), ')'),
		struct = paste(sum(wildfire_struct_destroyed, na.rm =T), '(', 100*sum(wildfire_struct_destroyed, na.rm =T) / sum(final$wildfire_struct_destroyed,na.rm =T), ')'),
	fatal = paste(sum(wildfire_max_civil_fatalities, na.rm =T), '(', 100*sum(wildfire_max_civil_fatalities, na.rm =T) / sum(final$wildfire_max_civil_fatalities,na.rm =T), ')'),	)
```

## Unmatched Events

```{r}
matched_events <- spatial$event_id %>% unlist(recursive = T) %>% unique() 
unmatched_events <- event %>% filter(!(event_id %in% matched_events)) %>%
	mutate( # add in criteria just like we did in spatial
			civ_crit    = if_else(
				coalesce(wildfire_max_civil_fatalities, wildfire_civil_fatalities, 0) > 0 | (is.na(wildfire_max_civil_fatalities) & (coalesce(wildfire_total_fatalities, 0) > 0)), 
				'civilian_death', 
				NA_character_
			),
			struct_crit = if_else(
				coalesce(wildfire_struct_destroyed, 0) > 0, 
				'structures_destroyed', 
				NA_character_
			),
			fema_crit   = if_else(wildfire_fema_dec, 'fema_fmag_declaration', NA_character_)
		) %>%
		unite(wildfire_disaster_criteria_met, c(civ_crit, struct_crit, fema_crit), sep = '|', na.rm = TRUE) %>%
	filter(wildfire_disaster_criteria_met != '')
```

unmatched events total: `r nrow(unmatched_events)`

By criteria met:

```{r}
unmatched_events %>%
	group_by(wildfire_disaster_criteria_met) %>%
	summarize(n = n())
```

Of the actual lat longs provided (n = `r sum(!is.na(unmatched_events$wildfire_poo_lon_ics209))`), none fall in the united states.

```{r}
ggplot() + 
	geom_sf(data = tigris::states(cb = TRUE, year = 2024, progress_bar = FALSE)) + 
	geom_sf(data = st_as_sf(unmatched_events, coords = c('wildfire_poo_lon_ics209', 'wildfire_poo_lat_ics209'), crs = 4269, na.fail = FALSE))
```

`r sum(is.na(unmatched_events$wildfire_states) | !(unmatched_events$wildfire_states %in% c(state.abb, 'DC', 'PR', 'GU', 'VI')))` Had no state information or invalid state information

Of the ones that did have a recoverable state:

```{r}
unmatched_events %>%
	filter(wildfire_states %in% c(state.abb, 'DC', 'PR', 'GU', 'VI')) %>% 
	group_by(wildfire_states) %>%
	summarize(n = n()) %>%
	arrange(desc(n), wildfire_states) %>%
	print(n = 40)
```

The data sources for the unmatched events were:

```{r}
unmatched_events %>%
	group_by(match_ics209 = !is.na(ics_id), match_redbook = !is.na(redbook_id), match_fema = !is.na(fema_id)) %>%
	summarize(n())
```
